#!/bin/bash

m4_changequote({{,}})
m4_changecom({{###}})

[ -z "$PS1" ] && return

if [ -z "$TMUX" ] && command -v tmux > /dev/null &&
			groups "$USER" | tr ' ' '\n' | grep -q '^tmuxers$' &&
			[ -z "$(tmux list-clients)" ]; then
	if [ "$USER" = root ]; then
		SHLVL=0 nice -n -40 tmux new -A -c ~
	else
		SHLVL=0 tmux new -A -c ~
	fi
fi

m4_include(promptfunc)

stty ixon ixoff ek ixany # 'ek' fixes ctrl+backspace

if command -v fzf >/dev/null; then
	hist() {
		# sort & uniq by second field; then "unsort" using first field
		cmd="$(history | sort -u -k2 | sort -n |
			sed -n 's/^\s*[0-9]*\s*//; /......../p' |
			fzf --tac --reverse --height='80%')"
		printf '%s\n' "$cmd"
	}
	bind -x '"\C-r": "history -s $(hist)"'
fi

# Ctrl-Down
bind -x '"\e[1;5B": "cd ..; $PROMPT_COMMAND"'
bind    '"\C-g\C-k": "git commit -m \"\"\e[D"'
bind    '"\C-f": " | grep '\'\''\e[D"'
bind -x '"\ec": "history -s $READLINE_LINE"'
bind    '"\\": "|"'

# list files upon completing empty line
complete -Ef

shopt -s histreedit histverify histappend autocd dirspell cdspell globstar checkwinsize
printf 'm4_esyscmd(tabs 4 </dev/ptmx >&0 2>&0)'

HISTSIZE=2000
HISTCONTROL=ignoredups:ignorespace:erasedups

m4_include(less_termcap)

# disable the "command not found" event if it's slow
unset command_not_found_handle

m4_include(portable_aliases)

if [ -f /usr/local/etc/bashrc ]; then
	. /usr/local/etc/bashrc
fi

if [ -f ~/.bashrc_local ]; then
	. ~/.bashrc_local
fi
