#!/bin/bash

m4_changequote({{,}})
m4_changecom({{###}})

# ~/.bashrc: executed by bash(1) for non-login shells.
# see /usr/share/doc/bash/examples/startup-files (in the package bash-doc)
# for examples

# If not running interactively, don't do anything
[ -z "$PS1" ] && return

m4_include(promptfunc)

$PROMPT_COMMAND

if [ -f ~/.path ]; then
	export PATH="$(cat ~/.path | grep '^/' | tr '\n' ':' | sed -E 's/::+/:/g; s/:$//')"
else
	export PATH='/usr/local/bin:/usr/bin:bin'
fi

# check the window size after each command and, if necessary,
# update the values of LINES and COLUMNS.
shopt -s checkwinsize

if [ -z "$TMUX" ] && [ -z "$SSH_CLIENT" ] && command -v tmux > /dev/null; then
#	if ! timeout -s KILL 1s tmux run-shell true; then
#		pkill -9 'tmux: server'
#		pkill -9 'tmux: client'
#		echo 'Forcefully killed tmux' >&2
#		sleep 1
#	fi
	SHLVL=0 tmux new -A -c ~
fi

stty ixon
stty ixoff
stty ek # fix ctrl+backspace
stty ixany

_clear_bytes="$(clear -x)"
bind -x '"\C-l": printf %s "$_clear_bytes"; echo; $PROMPT_COMMAND'
# Ctrl-Down
bind -x '"\e[1;5B": "cd ..; $PROMPT_COMMAND"'
bind    '"\C-k": "git commit -m \"\"\e[D"'
bind    '"\C-f": "!! | grep '\'\''\e[D"'
bind -x '"\ec": "history -s $READLINE_LINE"'
bind    '"\\": "|"'

# list files upon completing empty line
complete -Ef

shopt -s histreedit
shopt -s histverify
shopt -s autocd
shopt -s dirspell
shopt -s cdspell
shopt -s globstar
# lesson learnt - nullglob is a bad idea because it breaks variable expansion
shopt -u extdebug

#trap 'kill $(jobs -p) 2>/dev/null' EXIT

export LANG='en_US.utf8'
export IGNOREEOF='1'
export JAVA_OPTS='-Djava.awt.headless=true'
export FIGNORE='..:.'
export GRADLE_OPTS=''
# export TERM='xterm-256color'
BROWSER_AGENT='Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.89 Safari/537.36'

less_prompt='file\ %g\ (%i\ of\ %m)\ line\ %ltâ•±%L\ =\ %Pt\%'
export LESS='--jump-target=2 --tabs=3 --RAW-CONTROL-CHARS --QUIET --ignore-case --clear-screen -P'"$less_prompt"
export MANOPT='--nh -r '"${less_prompt/\%g/\$MAN_PN}"
export GPG_TTY="$(tty)"

# set tab size to 4
tabs 4

# by default, create rwx directories, but don't let anyone else near them
umask 077
# allow core dumps
ulimit -c unlimited

HISTCONTROL=ignoredups:ignorespace
unset HISTFILE
# append to the history file, don't overwrite it
# shopt -s histappend

# make less more friendly for non-text input files, see lesspipe(1)
command -v lesspipe >/dev/null && eval "$(SHELL=/bin/sh lesspipe)"

m4_include(less_termcap)

export PAGER="$(command -v less)"
export EDITOR="$(command -v nano)"
export VISUAL="$EDITOR"
export LESSGLOBALTAGS=global

command -v lesspipe.sh >/dev/null && export LESSOPEN='||lesspipe.sh %s'

# disable the "command not found" event if it's slow
unset command_not_found_handle

m4_include(portable_aliases)

# enable programmable completion features (you don't need to enable
# this, if it's already enabled in /etc/bash.bashrc and /etc/profile
# sources /etc/bash.bashrc).
if [ -f /etc/bash_completion ] && ! shopt -oq posix; then
	. /etc/bash_completion
fi


m4_syscmd(command -v colorspec >/dev/null)
m4_ifelse(0,m4_sysval,{{
export LS_COLORS="m4_esyscmd(colorspec -Fls lscolors)"
export GCC_COLORS="m4_esyscmd(colorspec -Fgcc gcccolors)"
}})
if [ -f /usr/local/etc/bashrc ]; then
	. /usr/local/etc/bashrc
fi

if [ -f ~/.bashrc_local ]; then
	. ~/.bashrc_local
fi
